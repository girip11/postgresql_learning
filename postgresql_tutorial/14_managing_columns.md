# Managing Collumns

## Adding Columns

```Sql
-- Adding a column
ALTER TABLE table_name
ADD COLUMN column_name data_type column_constraint;
```

## Altering Columns

```Sql
-- renaming a column
-- PostgreSQL does not provide the IF EXISTS
-- option for the RENAME clause.
-- New name is reflected in all dependent objects automatically
ALTER TABLE table_name
RENAME COLUMN column_name
TO new_column_name;

-- change column data type
-- USING expression can help convert data explicitly
-- from old type to new type.
-- Its recommended to use USING rather than to rely on
-- postgresql implicit conversion
ALTER TABLE table_name
ALTER COLUMN column_name [ SET DATA ] TYPE data_type [USING expression];

-- Set or delete default
ALTER TABLE table_name
ALTER COLUMN column_name
[SET DEFAULT value | DROP DEFAULT];

-- set or remove NOT NULL constraint
ALTER TABLE table_name
ALTER COLUMN column_name
[SET NOT NULL| DROP NOT NULL];
```

## Deleting columns

* When you remove a column from a table, PostgreSQL will automatically remove all of the indexes and constraints that involved the dropped column.

```Sql
-- Deleting a column
ALTER TABLE table_name
DROP COLUMN [IF EXISTS] column_name [CASCADE];
```

* `CASCADE` deletes all views, constraints, functions where the column is referenced.

## Column of type `SERIAL`

`SERIAL` is not an Sql standard. Assigning `SMALSERIAL`(2 bytes), `SERIAL`(4 bytes) and `BIGSERIAL`(8 bytes) pseudo-types to a column does the following

* Creates a sequence object and associates with the column. When the column is deleted, the sequence object is also removed.
* Next value of the sequence is set as the default value of the column and sequence object gets auto incremented everytime a value is used.
* The column implicitly gets the `NOT NULL` condition, since the sequence never returns `NULL`

`SERIAL` is used as the type of the columns that needs to be the **primary key**

```Sql
CREATE TABLE table_name(
    id SERIAL
);

-- above statement is equivalent to
CREATE SEQUENCE table_name_id_seq;

CREATE TABLE table_name (
    id integer NOT NULL DEFAULT nextval('table_name_id_seq')
);

ALTER SEQUENCE table_name_id_seq
OWNED BY table_name.id;
```

* `pg_get_serial_sequence(table_name, column_name)`  returns the name of the sequence associated with the `SERIAL` column

* `currval(pg_get_serial_sequence(table_name, column_name))` returns the recent value generated by the sequence.

**NOTE**: The sequence generator operation is **not transaction-safe** (i.e) generated value within a transaction cannot be rolled back.

## Identity Column

> `GENERATED AS IDENTITY` is same as `SERIAL` but conforms to SQL standard. PostgreSQL allows you a table to have more than one identity column. Like the SERIAL, the GENERATED AS IDENTITY constraint also uses the SEQUENCE object internally.

```Sql
-- Syntax
column_name type GENERATED { ALWAYS | BY DEFAULT } AS IDENTITY [( sequence_option)]
```

* `type` can be `SMALLINT`, `INT`, `BIGINT`

* `GENERATED ALWAYS`- user cannot provide a value for this column. If provided, error is raised. `OVERRIDING SYSTEM VALUE` clause needs to be used to override the generated value.

```Sql
INSERT INTO color (color_id, color_name)
OVERRIDING SYSTEM VALUE
VALUES(2, 'Green');
```

* `GENERATED BY DEFAULT` - user can supply otherwise generated value is used by default.

* Any existing column of type `INT`, `SMALLINT` or `BIGINT` with `NOT NULL` condition can be converted to identity column.

```Sql
-- add identity
ALTER TABLE table_name
ALTER COLUMN column_name
ADD GENERATED [ALWAYS | BY DEFAULT] AS IDENTITY [( sequence_option)];

-- change identity characteristics
ALTER COLUMN column_name
[ SET GENERATED [ALWAYS| BY DEFAULT] |
SET sequence_option |
RESTART [ [WITH] restart] ]

-- remove identity
ALTER TABLE table_name
ALTER COLUMN column_name
DROP IDENTITY [ IF EXISTS ]
```

* Sequence options can be found in [sequences](14_sequence.md)

---

## References

* [PostgreSQL CREATE TABLE](https://www.postgresqltutorial.com/postgresql-create-table/)
